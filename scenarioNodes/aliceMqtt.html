<!--
	This is almost a copy of the official Nore-red MQTT node found on node-red repository.
	It's been fitted to our needs of simplicity for everyday use and repackaged
-->

<script type="text/html" data-template-name="mqtt-broker">
	<div class="form-row">
		<label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
		<input type="text" id="node-config-input-name" data-i18n="[placeholder]common.label.name">
	</div>
	<div class="form-row">
		<ul style="min-width: 600px; margin-bottom: 20px;" id="node-config-mqtt-broker-tabs"></ul>
	</div>
	<div id="node-config-mqtt-broker-tabs-content" style="min-height:150px;">
		<div id="mqtt-broker-tab-connection" style="display:none">
			<div class="form-row node-input-broker">
				<label for="node-config-input-broker"><i class="fa fa-globe"></i> Host</label>
				<input type="text" id="node-config-input-broker" style="width:40%;" placeholder="localhost">
				<label for="node-config-input-port" style="margin-left:20px; width:43px; "> Port</label>
				<input type="text" id="node-config-input-port" placeholder="1883">
			</div>
			<div class="form-row">
				<input type="checkbox" id="node-config-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
				<label for="node-config-input-usetls" style="width: auto">Use TLS</label>
				<div id="node-config-row-tls" class="hide">
					<label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-config-input-tls"><span>TLS configs</span></label><input style="width: 300px;" type="text" id="node-config-input-tls">
				</div>
			</div>
		</div>
		<div id="mqtt-broker-tab-security" style="display:none">
			<div class="form-row">
				<label for="node-config-input-user"><i class="fa fa-user"></i> User</label>
				<input type="text" id="node-config-input-user">
			</div>
			<div class="form-row">
				<label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
				<input type="password" id="node-config-input-password">
			</div>
		</div>
	</div>
</script>

<script type="text/javascript">
	RED.nodes.registerType('mqtt-broker', {
		category     : 'config',
		defaults     : {
			name            : {value: ""},
			broker          : {value: "", required: true},
			port            : {value: 1883, required: false, validate: RED.validators.number(true)},
			tls             : {type: "tls-config", required: false},
			usetls          : {value: false},
			verifyservercert: {value: false}
		},
		credentials  : {
			user    : {type: "text"},
			password: {type: "password"}
		},
		label        : 'AliceMqtt',
		oneditprepare: function () {
			let tabs = RED.tabs.create({
				id      : "node-config-mqtt-broker-tabs",
				onchange: function (tab) {
					$("#node-config-mqtt-broker-tabs-content").children().hide();
					$("#" + tab.id).show();
				}
			});
			tabs.addTab({
				id   : "mqtt-broker-tab-connection",
				label: this._("mqtt.tabs-label.connection")
			});
			tabs.addTab({
				id   : "mqtt-broker-tab-security",
				label: this._("mqtt.tabs-label.security")
			});

			setTimeout(function () {
				tabs.resize();
			}, 0);
			if (typeof this.cleansession === 'undefined') {
				this.cleansession = true;
				$("#node-config-input-cleansession").prop("checked", true);
			}
			if (typeof this.usetls === 'undefined') {
				this.usetls = false;
				$("#node-config-input-usetls").prop("checked", false);
			}

			function updateTLSOptions() {
				if ($("#node-config-input-usetls").is(':checked')) {
					$("#node-config-row-tls").show();
				} else {
					$("#node-config-row-tls").hide();
				}
			}

			updateTLSOptions();
			$("#node-config-input-usetls").on("click", function () {
				updateTLSOptions();
			});
		},
		oneditsave   : function () {
			if (!$("#node-config-input-usetls").is(':checked')) {
				$("#node-config-input-tls").val("");
			}
		}
	});
</script>
